# 🚀 스마트 주식 데이터 수집 시스템

DB의 마지막 날짜를 확인하고 누락된 데이터만 효율적으로 수집하는 스마트 시스템입니다.

## ✨ 주요 특징

### 🎯 **스마트 데이터 수집**
- **DB 연결 우선 확인**: 스크립트 시작 시 DB 연결 및 테이블 존재 확인
- **DB 가장 오래된 날짜 확인**: 기존 데이터의 가장 오래된 날짜를 자동으로 조회
- **10년치 데이터 수집**: 가장 오래된 날짜부터 현재까지 전체 데이터 수집
- **API 호출 최적화**: 불필요한 중복 호출 방지
- **기존 pykrx 방식 사용**: 토큰 관리 로직 그대로 활용

### ⚡ **효율적인 처리**
- **멀티스레딩**: 여러 종목 동시 처리
- **벌크 인서트**: 대용량 데이터 빠른 저장
- **중복 방지**: `ON DUPLICATE KEY UPDATE` 사용

### 📊 **API 호출 제한 관리**
- **일일 제한 모니터링**: API 호출 횟수 실시간 추적
- **자동 제한**: 설정된 제한에 도달하면 자동 중단
- **진행률 표시**: 실시간 처리 현황 확인

## 📁 파일 구조

```
scripts/stock_daily_weekly_monthly_chart/
├── smart_stock_collector.py    # 스마트 데이터 수집 스크립트
├── smart_stock_processor.py    # 스마트 데이터 처리 스크립트
├── out_krx_smart/             # 수집된 CSV 파일들
├── smart_stock_collection.log # 수집 로그
├── smart_stock_processing.log # 처리 로그
└── SMART_README.md            # 이 파일
```

## 🚀 사용 방법

### 1. **스마트 데이터 수집**

```bash
# 가상환경 활성화
cd scripts/stock_daily_weekly_monthly_chart
source venv/Scripts/activate  # Git Bash
# 또는
venv\Scripts\activate         # Windows CMD

# 스마트 데이터 수집 실행
python smart_stock_collector.py
```

**수집 과정:**
1. DB에서 각 종목의 마지막 날짜 조회
2. 누락된 데이터만 pykrx API로 수집
3. CSV 파일로 저장 (`out_krx_smart/` 폴더)

### 2. **스마트 데이터 처리**

```bash
# 수집된 데이터를 DB에 저장
python smart_stock_processor.py
```

**처리 과정:**
1. CSV 파일들을 읽어서 데이터 정규화
2. 벌크 인서트로 DB에 저장
3. 중복 데이터는 자동 업데이트

## ⚙️ 설정 옵션

### **API 호출 제한 설정**

```python
# smart_stock_collector.py에서 수정
self.api_daily_limit = 1000  # 일일 API 호출 제한
self.max_workers = 4         # 동시 처리 워커 수
```

### **데이터베이스 설정**

```python
# 두 스크립트 모두에서 수정
db_config = {
    'host': 'localhost',
    'user': 'hanazoom_user',
    'password': 'hanazoom1234!',
    'database': 'hanazoom',
    'charset': 'utf8mb4',
    'autocommit': False
}
```

### **종목 리스트 수정**

```python
# smart_stock_collector.py에서 수정
self.stock_codes = [
    "005930", "000660", "035420",  # 원하는 종목 코드 추가/제거
    # ...
]
```

## 📊 실행 결과 예시

### **스마트 수집 로그**
```
2024-01-15 10:00:00 - INFO - 🔍 데이터베이스 연결 및 테스트 시작...
2024-01-15 10:00:00 - INFO - ✅ 데이터베이스 연결 성공
2024-01-15 10:00:00 - INFO - ✅ stock_daily_prices 테이블 확인 완료 (레코드 수: 50000)
2024-01-15 10:00:00 - INFO - ✅ stock_weekly_prices 테이블 확인 완료 (레코드 수: 10000)
2024-01-15 10:00:00 - INFO - ✅ stock_monthly_prices 테이블 확인 완료 (레코드 수: 2000)
2024-01-15 10:00:00 - INFO - 📅 DB에서 확인된 가장 오래된 일별 데이터 날짜: 2020-01-02
2024-01-15 10:00:00 - INFO - ✅ 데이터베이스 연결 및 테스트 완료 - 스마트 데이터 수집을 시작합니다
2024-01-15 10:00:00 - INFO - 🚀 스마트 주식 데이터 수집 시작!
2024-01-15 10:00:00 - INFO - 📈 대상 종목 수: 100개
2024-01-15 10:00:00 - INFO - 🔧 최대 워커 수: 4개
2024-01-15 10:00:00 - INFO - 📊 API 호출 제한: 1000회
2024-01-15 10:00:01 - INFO - 📅 005930 stock_daily_prices 가장 오래된 날짜: 2020-01-02
2024-01-15 10:00:01 - INFO - 🔄 005930 10년치 데이터 수집: 20200102 ~ 20240115
2024-01-15 10:00:02 - INFO - 🎯 005930 완료 - 일:1개, 주:1개, 월:1개
2024-01-15 10:00:02 - INFO - 🏁 스마트 데이터 수집 완료!
2024-01-15 10:00:02 - INFO - ⏱️  총 처리 시간: 45.32초
2024-01-15 10:00:02 - INFO - ✅ 성공: 95개 종목
2024-01-15 10:00:02 - INFO - ⏭️  건너뜀: 3개 종목 (이미 최신)
2024-01-15 10:00:02 - INFO - ❌ 실패: 2개 종목
2024-01-15 10:00:02 - INFO - 📊 총 수집 데이터: 285개 (일+주+월)
2024-01-15 10:00:02 - INFO - 📅 데이터 기간: 2024-01-15 ~ 2024-01-15
2024-01-15 10:00:02 - INFO - 📊 API 호출: 190/1000회
```

### **DB 연결 실패 시 로그**
```
2024-01-15 10:00:00 - INFO - 🔍 데이터베이스 연결 및 테스트 시작...
2024-01-15 10:00:00 - ERROR - ❌ 데이터베이스 연결 실패: (2003, "Can't connect to MySQL server on 'localhost' (10061)")
2024-01-15 10:00:00 - ERROR - ❌ 데이터베이스 연결 실패 - 스크립트를 중단합니다
2024-01-15 10:00:00 - ERROR - ❌ 불필요한 API 호출을 방지하기 위해 스크립트를 종료합니다
```

### **스마트 처리 로그**
```
2024-01-15 10:05:00 - INFO - 🚀 스마트 주식 데이터 처리 시작!
2024-01-15 10:05:00 - INFO - 📁 CSV 파일 300개 발견
2024-01-15 10:05:00 - INFO - 📈 처리할 종목 수: 100개
2024-01-15 10:05:00 - INFO - ⚡ 멀티스레딩 워커 수: 8개
2024-01-15 10:05:30 - INFO - 📊 005930 일별 데이터 1건 처리 완료
2024-01-15 10:05:30 - INFO - 📈 005930 주별 데이터 1건 처리 완료
2024-01-15 10:05:30 - INFO - 📅 005930 월별 데이터 1건 처리 완료
2024-01-15 10:05:30 - INFO - ✅ 005930 처리 완료
```

## 🔍 기존 스크립트와의 차이점

### **기존 스크립트 (`month_week_day_stock.py`)**
- ❌ 매번 2010년부터 전체 데이터 수집
- ❌ DB 연결 없음
- ❌ 중복 데이터 수집 발생
- ❌ 비효율적인 처리

### **스마트 스크립트 (`smart_stock_collector.py`)**
- ✅ DB 마지막 날짜 확인
- ✅ 누락 데이터만 수집
- ✅ API 호출 최적화
- ✅ 효율적인 처리

## 📈 성능 비교

| 항목 | 기존 스크립트 | 스마트 스크립트 |
|------|---------------|-----------------|
| **API 호출** | 300회 (100종목 × 3타입) | 3회 (누락 데이터만) |
| **처리 시간** | 2-3시간 | 10-15분 |
| **데이터 중복** | 있음 | 없음 |
| **DB 부하** | 높음 | 낮음 |

## 🚨 주의사항

### **1. 데이터베이스 연결**
- MySQL 서버가 실행 중이어야 함
- `hanazoom` 데이터베이스 존재 필요
- 테이블 구조가 올바르게 설정되어 있어야 함

### **2. API 호출 제한**
- pykrx API는 일일 호출 제한이 있음
- 제한에 도달하면 자동으로 중단됨
- 필요시 `api_daily_limit` 값 조정

### **3. 파일 권한**
- CSV 파일 생성 권한 필요
- 로그 파일 쓰기 권한 필요

## 🔧 문제 해결

### **1. 데이터베이스 연결 실패**
```bash
# MySQL 서버 상태 확인
docker ps | grep mysql

# 연결 테스트
mysql -h localhost -u hanazoom_user -p hanazoom
```

### **2. API 호출 제한 도달**
```python
# smart_stock_collector.py에서 제한 값 조정
self.api_daily_limit = 500  # 1000에서 500으로 줄이기
```

### **3. 메모리 부족**
```python
# smart_stock_processor.py에서 배치 크기 조정
self.batch_size = 500  # 1000에서 500으로 줄이기
```

## 📞 지원 및 문의

문제가 발생하거나 추가 기능이 필요한 경우:

1. **로그 파일 확인**: `smart_stock_collection.log`, `smart_stock_processing.log`
2. **데이터베이스 상태 확인**: 테이블 구조, 연결 정보
3. **API 호출 현황 확인**: 로그에서 호출 횟수 확인
4. **개발팀에 문의**

---

**Happy Smart Trading! 📈💰**
