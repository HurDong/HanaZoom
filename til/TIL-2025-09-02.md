# TIL 2025-09-02

## π“ νΈκ°€μ°½ κΈ°λ° μ£Όλ¬Έ μ²΄κ²° μ‹μ¤ν… κµ¬ν„

### π― μ”κµ¬μ‚¬ν•­
- ν„μ¬κ°€κ°€ μ£Όλ¬Έκ°€κ²©λ³΄λ‹¤ μ λ¦¬ν• λ°©ν–¥μΌλ΅ μ›€μ§μΌ λ• μ²΄κ²°
- νΈκ°€μ°½μ—μ„ κ°€μ¥ ν•μ„ μ°μ„ μμ„λ΅ μ²λ¦¬ (μ¦‰μ‹ μ²΄κ²°)
- μ‹¤μ‹κ°„ κ°€κ²© λ³€λ™μ— λ”°λ¥Έ μλ™ μ²΄κ²°

### π”§ κµ¬ν„ν• μ»΄ν¬λ„νΈ

#### 1. OrderMatchingService
```java
// λ§¤μ μ£Όλ¬Έ: ν„μ¬κ°€ β‰¤ μ£Όλ¬Έκ°€κ²© β†’ μ²΄κ²°
// λ§¤λ„ μ£Όλ¬Έ: ν„μ¬κ°€ β‰¥ μ£Όλ¬Έκ°€κ²© β†’ μ²΄κ²°
```

**μ£Όμ” κΈ°λ¥:**
- `processOrderMatching()`: μ‹¤μ‹κ°„ κ°€κ²© λ³€λ™ μ‹ μ£Όλ¬Έ λ§¤μΉ­
- `processBuyOrders()`: λ§¤μ μ£Όλ¬Έ μ²΄κ²° λ΅μ§
- `processSellOrders()`: λ§¤λ„ μ£Όλ¬Έ μ²΄κ²° λ΅μ§
- `executeOrder()`: μ‹¤μ  μ²΄κ²° μ‹¤ν–‰
- `updatePortfolio()`: ν¬νΈν΄λ¦¬μ¤ μλ™ μ—…λ°μ΄νΈ
- `sendExecutionNotification()`: μ²΄κ²° μ•λ¦Ό μ „μ†΅

#### 2. OrderRepository ν™•μ¥
```java
// λ§¤μ μ£Όλ¬Έμ„ κ°€κ²© λ‚΄λ¦Όμ°¨μμΌλ΅ μ΅°ν
@Query("SELECT o FROM Order o JOIN o.stock s WHERE s.symbol = :stockCode AND o.orderType = 'BUY' AND o.status = 'PENDING' ORDER BY o.price DESC")

// λ§¤λ„ μ£Όλ¬Έμ„ κ°€κ²© μ¤λ¦„μ°¨μμΌλ΅ μ΅°ν  
@Query("SELECT o FROM Order o JOIN o.stock s WHERE s.symbol = :stockCode AND o.orderType = 'SELL' AND o.status = 'PENDING' ORDER BY o.price ASC")
```

#### 3. StockWebSocketHandler μ—°λ™
- μ‹¤μ‹κ°„ κ°€κ²© λ°μ΄ν„° μμ‹  μ‹ μλ™μΌλ΅ `OrderMatchingService` νΈμ¶
- μ²΄κ²° μ•λ¦Ό μ›Ήμ†μΌ“ μ „μ†΅ κΈ°λ¥ μ¶”κ°€

#### 4. OrderServiceImpl κ°μ„ 
- μ‹μ¥κ°€ μ£Όλ¬Έ μ‹ μ¦‰μ‹ μ²΄κ²° μ²λ¦¬
- μ£Όλ¬Έ μƒμ„± ν›„ λ§¤μΉ­ μ„λΉ„μ¤ μ—°λ™

### π“ μ²΄κ²° λ΅μ§ νλ¦„

```mermaid
graph TD
    A[μ‹¤μ‹κ°„ κ°€κ²© μμ‹ ] --> B[OrderMatchingService νΈμ¶]
    B --> C{μ£Όλ¬Έ νƒ€μ… ν™•μΈ}
    C -->|λ§¤μ| D[ν„μ¬κ°€ β‰¤ μ£Όλ¬Έκ°€κ²©?]
    C -->|λ§¤λ„| E[ν„μ¬κ°€ β‰¥ μ£Όλ¬Έκ°€κ²©?]
    D -->|Yes| F[λ§¤μ μ£Όλ¬Έ μ²΄κ²°]
    D -->|No| G[λ€κΈ°]
    E -->|Yes| H[λ§¤λ„ μ£Όλ¬Έ μ²΄κ²°]
    E -->|No| G
    F --> I[ν¬νΈν΄λ¦¬μ¤ μ—…λ°μ΄νΈ]
    H --> I
    I --> J[μ²΄κ²° μ•λ¦Ό μ „μ†΅]
    J --> K[μ›Ήμ†μΌ“μΌλ΅ ν΄λΌμ΄μ–ΈνΈ μ•λ¦Ό]
```

### π― μ²΄κ²° μ΅°κ±΄

#### λ§¤μ μ£Όλ¬Έ
- **μ΅°κ±΄**: `ν„μ¬κ°€ β‰¤ μ£Όλ¬Έκ°€κ²©`
- **μμ‹**: 50,000μ›μ— λ§¤μ μ£Όλ¬Έ β†’ ν„μ¬κ°€κ°€ 49,000μ›μ΄ λλ©΄ μ²΄κ²°
- **μ°μ„ μμ„**: κ°€κ²©μ΄ λ†’μ€ μμ„λ€λ΅ (λ‚΄λ¦Όμ°¨μ)

#### λ§¤λ„ μ£Όλ¬Έ  
- **μ΅°κ±΄**: `ν„μ¬κ°€ β‰¥ μ£Όλ¬Έκ°€κ²©`
- **μμ‹**: 50,000μ›μ— λ§¤λ„ μ£Όλ¬Έ β†’ ν„μ¬κ°€κ°€ 51,000μ›μ΄ λλ©΄ μ²΄κ²°
- **μ°μ„ μμ„**: κ°€κ²©μ΄ λ‚®μ€ μμ„λ€λ΅ (μ¤λ¦„μ°¨μ)

### π”„ μ‹¤μ‹κ°„ μ²λ¦¬
1. **KIS μ›Ήμ†μΌ“**μ—μ„ μ‹¤μ‹κ°„ κ°€κ²© μμ‹ 
2. **StockWebSocketHandler**μ—μ„ `OrderMatchingService` νΈμ¶
3. **λ§¤μΉ­ μ΅°κ±΄** ν™•μΈ ν›„ μ¦‰μ‹ μ²΄κ²°
4. **ν¬νΈν΄λ¦¬μ¤** μλ™ μ—…λ°μ΄νΈ
5. **μ›Ήμ†μΌ“**μΌλ΅ μ²΄κ²° μ•λ¦Ό μ „μ†΅

### β… μ™„μ„±λ κΈ°λ¥
- β… νΈκ°€μ°½ κΈ°λ° μ£Όλ¬Έ λ§¤μΉ­ μ—”μ§„
- β… μ‹¤μ‹κ°„ μ£Όλ¬Έ μ²΄κ²° μ„λΉ„μ¤
- β… ν¬νΈν΄λ¦¬μ¤ μλ™ μ—…λ°μ΄νΈ
- β… μ²΄κ²° μ•λ¦Ό μ‹μ¤ν…

### π€ λ‹¤μ λ‹¨κ³„
- [ ] μ‚¬μ©μλ³„ μ›Ήμ†μΌ“ μ„Έμ… κ΄€λ¦¬
- [ ] μ²΄κ²° λ‚΄μ—­ μƒμ„Έ μ΅°ν
- [ ] λ¶€λ¶„ μ²΄κ²° μ²λ¦¬
- [ ] μ£Όλ¬Έ μ·¨μ† μ‹ λ§¤μΉ­μ—μ„ μ μ™Έ