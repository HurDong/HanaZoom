# TIL 2025-09-05

## π― μ¤λ κµ¬ν„ν• κ²ƒ

### 1. WebRTC λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ μ§€μ› μ‹μ¤ν… κµ¬ν„

- **λ¬Έμ **: ν„μ¬ ν™”μƒμ±„ν… μ„λ²„κ°€ ν•λ‚μ μ—”λ“ν¬μΈνΈλ΅λ§ λ™μ‘ν•μ—¬ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— μ΄μ©ν•  λ• μ„Έμ… μ¶©λ λ° κ²©λ¦¬ λ¬Έμ κ°€ λ°μƒν•  μ μμ—μ.
- **ν•΄κ²°**: WebSocket μ—”λ“ν¬μΈνΈμ— ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό μ¶”κ°€ν•μ—¬ κ° ν΄λΌμ΄μ–ΈνΈλ³„λ΅ λ…λ¦½μ μΈ μ„Έμ…μ„ μƒμ„±ν•κ³ , ν΄λΌμ΄μ–ΈνΈ κ°„ μ™„μ „ν• κ²©λ¦¬λ¥Ό λ³΄μ¥ν•λ” μ‹μ¤ν…μ„ κµ¬ν„ν•¨.
- **μ μ©**: λ°±μ—”λ“ WebSocket μ„¤μ •λ¶€ν„° ν”„λ΅ νΈμ—”λ“ μ—°κ²° λ΅μ§κΉμ§€ μ „λ©΄ μμ •ν•μ—¬ λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ λ™μ‹ μ§€μ›μ΄ κ°€λ¥ν•λ„λ΅ κ°μ„ .

```java
// BE/HanaZoom/src/main/java/com/hanazoom/global/config/WebSocketConfig.java
// μƒλ΅μ΄ μ—”λ“ν¬μΈνΈ: ν΄λΌμ΄μ–ΈνΈλ³„ κµ¬λ¶„
registry.addEndpoint("/ws/consultation/{clientId}")
        .setAllowedOriginPatterns("*")
        .withSockJS();

// κΈ°μ΅΄ μ—”λ“ν¬μΈνΈ: νΈν™μ„± μ μ§€
registry.addEndpoint("/ws/consultation")
        .setAllowedOriginPatterns("*")
        .withSockJS();
```

### 2. ν΄λΌμ΄μ–ΈνΈλ³„ μ„Έμ… κ²©λ¦¬ μ‹μ¤ν…

- **ν•µμ‹¬**: `clientId:consultationId` ν•νƒμ λ³µν•© ν‚¤λ΅ μ„Έμ… κ΄€λ¦¬
- **κµ¬ν„**: `WebRTCSignalingController`μ—μ„ ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό μ¶”μ¶ν•κ³  μ„Έμ… ν‚¤λ¥Ό μƒμ„±ν•μ—¬ κ° ν΄λΌμ΄μ–ΈνΈκ°€ λ…λ¦½μ μΈ ν™”μƒμ±„ν… μ„Έμ…μ—μ„ λ™μ‘ν•λ„λ΅ λ³΄μ¥
- **λ΅κΉ…**: ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό ν¬ν•¨ν• μƒμ„Έ λ΅κ·Έλ΅ λ””λ²„κΉ… λ° λ¨λ‹ν„°λ§ κ°μ„ 

```java
// BE/HanaZoom/src/main/java/com/hanazoom/domain/consultation/websocket/WebRTCSignalingController.java
// ν΄λΌμ΄μ–ΈνΈλ³„ μƒλ‹΄ μ„Έμ… μƒμ„± λλ” μ°Έμ—¬
String sessionKey = clientId + ":" + consultationId;
ConsultationSession session = activeSessions.computeIfAbsent(sessionKey, 
    key -> new ConsultationSession(consultationId, clientId));

log.info("ν΄λΌμ΄μ–ΈνΈ {}μ—μ„ μ‚¬μ©μ {}κ°€ μƒλ‹΄ {}μ— μ°Έμ—¬ μ‹λ„ (μ—­ν• : {})", 
    clientId, userId, consultationId, userRole);
```

### 3. WebSocket μΈμ¦ μΈν„°μ…‰ν„° κ°μ„ 

- **κΈ°λ¥**: WebSocket μ—°κ²° μ‹ URLμ—μ„ ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό μλ™ μ¶”μ¶ν•κ³  μ„Έμ…μ— μ €μ¥
- **κµ¬ν„**: `WebSocketAuthInterceptor`μ—μ„ destination ν—¤λ”λ¥Ό νμ‹±ν•μ—¬ ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό μ¶”μ¶ν•κ³  μ„Έμ… μ†μ„±μ— μ €μ¥
- **νΈν™μ„±**: ν΄λΌμ΄μ–ΈνΈ IDκ°€ μ—†λ” κ²½μ° κΈ°λ³Έκ°’(`'default'`)μΌλ΅ μ²λ¦¬ν•μ—¬ κΈ°μ΅΄ μ½”λ“μ™€μ νΈν™μ„± μ μ§€

```java
// BE/HanaZoom/src/main/java/com/hanazoom/global/interceptor/WebSocketAuthInterceptor.java
private String extractClientIdFromDestination(StompHeaderAccessor accessor) {
    List<String> destinations = accessor.getNativeHeader("destination");
    if (destinations != null && !destinations.isEmpty()) {
        String destination = destinations.get(0);
        // /ws/consultation/{clientId} ν•νƒμ—μ„ clientId μ¶”μ¶
        if (destination != null && destination.contains("/ws/consultation/")) {
            String[] parts = destination.split("/");
            if (parts.length >= 4) {
                return parts[3]; // {clientId} λ¶€λ¶„
            }
        }
    }
    return "default";
}
```

### 4. ν”„λ΅ νΈμ—”λ“ ν΄λΌμ΄μ–ΈνΈ ID κ΄€λ¦¬ μ‹μ¤ν…

- **μλ™ μƒμ„±**: `getCurrentClientId()` ν•¨μλ΅ λΈλΌμ°μ € μ„Έμ… κΈ°λ° κ³ μ  ID μƒμ„±
- **μ„Έμ… μ μ§€**: `sessionStorage`λ¥Ό μ‚¬μ©ν•μ—¬ λΈλΌμ°μ € μƒλ΅κ³ μΉ¨ μ‹μ—λ„ ν΄λΌμ΄μ–ΈνΈ ID μ μ§€
- **WebSocket μ—°κ²°**: ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό ν¬ν•¨ν• URLλ΅ WebSocket μ—°κ²°

```typescript
// FE/lib/utils/clientId.ts
export function generateClientId(): string {
  const existingClientId = sessionStorage.getItem('hanazoom_client_id');
  if (existingClientId) {
    return existingClientId;
  }

  const clientId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  sessionStorage.setItem('hanazoom_client_id', clientId);
  return clientId;
}

// FE/hooks/useWebRTC.ts
const socket = new SockJS(`http://localhost:8080/ws/consultation/${clientId}?token=${encodeURIComponent(accessToken)}`);
```

### 5. λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ νμ΄μ§€ κµ¬ν„

- **κΈ°λ¥**: μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— ν™”μƒμ±„ν…μ„ μ΄μ©ν•  μ μλ”μ§€ ν…μ¤νΈν•λ” μ „μ© νμ΄μ§€
- **UI**: ν΄λΌμ΄μ–ΈνΈ ID μƒμ„±/κ΄€λ¦¬, μƒλ‹΄ μ„¤μ •, ν™”μƒμ±„ν… λ£Έμ„ ν†µν•©ν• ν…μ¤νΈ ν™κ²½ μ κ³µ
- **ν…μ¤νΈ μ‹λ‚λ¦¬μ¤**: λ™μΌν• μƒλ‹΄ IDλ΅ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ, λ‹¤λ¥Έ μƒλ‹΄ IDλ΅ λ…λ¦½ ν…μ¤νΈ λ“± λ‹¤μ–‘ν• μ‹λ‚λ¦¬μ¤ μ§€μ›

```typescript
// FE/app/webrtc-multi-client-test/page.tsx
const handleGenerateNewClientId = () => {
  const newClientId = resetClientId();
  setCurrentClientId(newClientId);
  setShowVideoRoom(false);
};

// ν΄λΌμ΄μ–ΈνΈ IDκ°€ μ κ³µλμ§€ μ•μΌλ©΄ μλ™ μƒμ„±
const actualClientId = clientId || getCurrentClientId();
```

### 6. VideoConsultationRoom μ»΄ν¬λ„νΈ κ°μ„ 

- **ν΄λΌμ΄μ–ΈνΈ ID μ§€μ›**: `clientId` prop μ¶”κ°€λ΅ νΉμ • ν΄λΌμ΄μ–ΈνΈ ID μ§€μ • κ°€λ¥
- **μλ™ μƒμ„±**: ν΄λΌμ΄μ–ΈνΈ IDκ°€ μ κ³µλμ§€ μ•μΌλ©΄ μλ™μΌλ΅ μƒμ„±ν•μ—¬ μ‚¬μ©
- **ν•μ„ νΈν™μ„±**: κΈ°μ΅΄ μ½”λ“ μμ • μ—†μ΄λ„ μƒλ΅μ΄ λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ κΈ°λ¥ μ‚¬μ© κ°€λ¥

## π§  μ¤λμ ν•™μµ

### ν•µμ‹¬ κΉ¨λ‹¬μ

> **"λ¶„μ‚° μ‹μ¤ν…μ—μ„μ μ„Έμ… κ²©λ¦¬λ” λ‹¨μν IDλ§ μ¶”κ°€ν•λ” κ²ƒμ΄ μ•„λ‹λΌ, μ „μ²΄ μ•„ν‚¤ν…μ²μ—μ„ μΌκ΄€λ κ²©λ¦¬ μ •μ±…μ„ μ μ©ν•΄μ•Ό ν•λ‹¤."**

### κΈ°μ μ  ν¬μΈνΈ

- **WebSocket μ—”λ“ν¬μΈνΈ μ„¤κ³„**: URL κ²½λ΅ λ³€μλ¥Ό ν™μ©ν• ν΄λΌμ΄μ–ΈνΈ κµ¬λ¶„μ΄ μΏΌλ¦¬ νλΌλ―Έν„°λ³΄λ‹¤ λ” λ…ν™•ν•κ³  RESTfulν• μ ‘κ·Ό λ°©μ‹
- **μ„Έμ… ν‚¤ μ„¤κ³„**: `clientId:consultationId` ν•νƒμ λ³µν•© ν‚¤λ΅ λ‹¤μ°¨μ› κ²©λ¦¬ κµ¬ν„μ΄ λ‹¨μΌ ν‚¤λ³΄λ‹¤ ν™•μ¥μ„±κ³Ό λ…ν™•μ„± λ©΄μ—μ„ μ°μ
- **νΈν™μ„± μ μ§€**: κΈ°μ΅΄ μ—”λ“ν¬μΈνΈλ¥Ό μ μ§€ν•λ©΄μ„ μƒλ΅μ΄ μ—”λ“ν¬μΈνΈλ¥Ό μ¶”κ°€ν•λ” μ μ§„μ  λ§μ΄κ·Έλ μ΄μ… μ „λµμ΄ μ•μ „ν•κ³  ν¨κ³Όμ 
- **ν”„λ΅ νΈμ—”λ“ μƒνƒ κ΄€λ¦¬**: `sessionStorage`λ¥Ό ν™μ©ν• ν΄λΌμ΄μ–ΈνΈ ID μ§€μ†μ„±μ΄ `localStorage`λ³΄λ‹¤ μ„Έμ… κΈ°λ° κ΄€λ¦¬μ— λ” μ ν•©

### μ•„ν‚¤ν…μ² μ„¤κ³„ μ›μΉ™

- **κ²©λ¦¬μ„±**: κ° ν΄λΌμ΄μ–ΈνΈκ°€ λ…λ¦½μ μΈ μ„Έμ…μ—μ„ λ™μ‘ν•μ—¬ μ„λ΅ κ°„μ„­ν•μ§€ μ•μ
- **ν™•μ¥μ„±**: λ¬΄μ ν• ν΄λΌμ΄μ–ΈνΈ λ™μ‹ μ§€μ› κ°€λ¥ν• κµ¬μ΅°
- **κ°€μ‹μ„±**: ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό ν†µν• λ΅κ·Έ μ¶”μ κ³Ό λ””λ²„κΉ… μ©μ΄μ„±
- **νΈν™μ„±**: κΈ°μ΅΄ μ½”λ“μ™€μ μ™„μ „ν• νΈν™μ„± μ μ§€

## π€ λ‚΄μΌ ν•  κ²ƒ

1. **Redis μ„Έμ… κ΄€λ¦¬**: λ¶„μ‚° ν™κ²½μ—μ„ ν΄λΌμ΄μ–ΈνΈ μ„Έμ…μ„ κ³µμ ν•  μ μλ„λ΅ Redis κΈ°λ° μ„Έμ… κ΄€λ¦¬ μ‹μ¤ν… κµ¬ν„
2. **ν΄λΌμ΄μ–ΈνΈ λ¨λ‹ν„°λ§**: ν™μ„± ν΄λΌμ΄μ–ΈνΈ μ, μ„Έμ… μƒνƒ, μ—°κ²° ν’μ§ λ“±μ„ μ‹¤μ‹κ°„μΌλ΅ λ¨λ‹ν„°λ§ν•λ” λ€μ‹λ³΄λ“ κµ¬ν„
3. **λ¶€ν• ν…μ¤νΈ**: λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ λ™μ‹ μ ‘μ† μ‹ μ„λ²„ μ„±λ¥ λ° μ•μ •μ„± κ²€μ¦
4. **ν΄λΌμ΄μ–ΈνΈ ID κ²€μ¦**: μ„λ²„μ—μ„ ν΄λΌμ΄μ–ΈνΈ ID μ ν¨μ„± κ²€μ‚¬ λ° λ³΄μ• κ°•ν™”

## π“ WebRTC λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ μ‹μ¤ν… μ•„ν‚¤ν…μ²

```mermaid
graph TD
    A[ν΄λΌμ΄μ–ΈνΈ A] -->|/ws/consultation/client_A| B[WebSocket μ„λ²„]
    C[ν΄λΌμ΄μ–ΈνΈ B] -->|/ws/consultation/client_B| B
    D[ν΄λΌμ΄μ–ΈνΈ C] -->|/ws/consultation/client_C| B
    
    B --> E[WebRTCSignalingController]
    E --> F[μ„Έμ… κ΄€λ¦¬]
    F --> G[client_A:consultation_1]
    F --> H[client_B:consultation_1]
    F --> I[client_C:consultation_2]
    
    G --> J[λ…λ¦½μ  ν™”μƒμ±„ν… μ„Έμ… A]
    H --> K[λ…λ¦½μ  ν™”μƒμ±„ν… μ„Έμ… B]
    I --> L[λ…λ¦½μ  ν™”μƒμ±„ν… μ„Έμ… C]
```

## π”§ κµ¬ν„λ μ£Όμ” κΈ°λ¥

- β… ν΄λΌμ΄μ–ΈνΈλ³„ WebSocket μ—”λ“ν¬μΈνΈ λ¶„λ¦¬
- β… ν΄λΌμ΄μ–ΈνΈλ³„ μ„Έμ… κ²©λ¦¬ μ‹μ¤ν…
- β… μλ™ ν΄λΌμ΄μ–ΈνΈ ID μƒμ„± λ° κ΄€λ¦¬
- β… λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ ν™κ²½
- β… κΈ°μ΅΄ μ½”λ“μ™€μ μ™„μ „ν• νΈν™μ„±
- β… μƒμ„Έν• λ΅κΉ… λ° λ””λ²„κΉ… μ§€μ›

## π― μ‹μ¤ν… μ¥μ 

1. **μ™„μ „ν• κ²©λ¦¬**: κ° ν΄λΌμ΄μ–ΈνΈκ°€ λ…λ¦½μ μΈ μ„Έμ…μ—μ„ λ™μ‘
2. **λ¬΄μ ν• ν™•μ¥**: μ΄λ΅ μ μΌλ΅ λ¬΄μ ν• ν΄λΌμ΄μ–ΈνΈ λ™μ‹ μ§€μ›
3. **μ‰¬μ΄ λ””λ²„κΉ…**: ν΄λΌμ΄μ–ΈνΈ ID κΈ°λ° λ΅κ·Έ μ¶”μ 
4. **μ μ§„μ  λ§μ΄κ·Έλ μ΄μ…**: κΈ°μ΅΄ μ½”λ“ μμ • μ—†μ΄ μƒ κΈ°λ¥ μ‚¬μ©
5. **μ μ—°ν• κ΄€λ¦¬**: μλ™ μƒμ„± λλ” μλ™ μ§€μ • λ¨λ‘ μ§€μ›

---

**Today's Key Insight**: λ‹¤μ¤‘ ν΄λΌμ΄μ–ΈνΈ μ§€μ›μ€ λ‹¨μν• κΈ°λ¥ μ¶”κ°€κ°€ μ•„λ‹λΌ, μ „μ²΄ μ‹μ¤ν… μ•„ν‚¤ν…μ²μ—μ„ κ²©λ¦¬μ™€ ν™•μ¥μ„±μ„ κ³ λ ¤ν• μ„¤κ³„κ°€ ν•µμ‹¬μ΄λ‹¤.
