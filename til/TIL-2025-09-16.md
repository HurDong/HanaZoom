# TIL - 2025-09-16

## 오늘의 작업: 지역×종목 인기도 점수식(균형형+추세) 설계 및 FE 연동 스켈레톤

### 🎯 한 줄 요약
전일 커뮤니티 지표와 최근 3일 거래 추세, `region_stocks` 모멘텀을 결합한 인기도 점수식을 정의하고, 뉴스 이슈는 점화식에만 포함(현재 값 0, UI 비표시)한 상태로 BE 조회 API/FE 도넛 시각화 스켈레톤을 구현했다.

---

## 📐 점수식 정의(균형형 + 추세 강화)

### 1) 정규화(지역 파티션별 min–max)
각 지표 x에 대해 같은 지역 내에서
\[ n_x = \frac{x - \min(x)}{\max(x) - \min(x)} \]\
분모가 0이면 0 처리.

### 2) 구성요소
- TradeTrend3d(거래 추세, 최근 3일):
  - 지표 예: net_buy_users_3d, net_buy_amount_3d, growth_buy_amount_3d
  - 결합 예: 0.5·n(net_buy_users_3d) + 0.4·n(net_buy_amount_3d) + 0.1·n(growth)

- CommunityComposite(커뮤니티, 전일):
  - 지표: post, comment, vote, like, unique_user
  - 내부 가중치(균형형): 글4, 댓글3, 투표2, 좋아요2, 고유유저3
  - 합: 4·n_post + 3·n_comment + 2·n_vote + 2·n_like + 3·n_user

- RegionMomentum(모멘텀):
  - 소스: `region_stocks`의 popularity_score 이동평균(예: 3일 EMA)
  - 값: n(momentum_3d)

- NewsImpact(뉴스/이슈):
  - 현재 값 0. 점화식에 자리는 확보, UI에서는 숨김 처리.

### 3) 최종 점수(0~100)
가중치(권장 시작값): wT=0.45, wC=0.35, wR=0.20, wN=0.00

\[ score = 100 \times \frac{w_T\cdot TradeTrend3d + w_C\cdot CommunityComposite + w_R\cdot RegionMomentum + w_N\cdot NewsImpact}{w_T + w_C + w_R + w_N} \]

### 4) 순위
동일 지역 파티션에서 score 내림차순 DENSE_RANK.

---

## 🧱 BE 스켈레톤(조회)
- 엔드포인트: `GET /api/v1/regions/{regionId}/stocks/{symbol}/popularity?date=latest|YYYY-MM-DD`
- DTO: `PopularityDetailsResponse`
  - 필드: regionId, symbol, date, score(0~100), tradeTrend, community, momentum, newsImpact(0),
    weightTradeTrend, weightCommunity, weightMomentum, weightNews, postCount, commentCount, voteCount, viewCount
- 현재 상태: 값은 0 기반의 스켈레톤. 배치 연결/집계 완료 후 실제 값 주입 예정.

---

## 🗺️ FE 연동(지도 모달)
- 위치: `app/map/page.tsx` 모달 내 “인기도 기여도(전일)” 섹션
- 컴포넌트: `components/popularity-donut.tsx`
  - 기능: regionId+symbol로 상세 조회 → 도넛 차트 렌더
  - 안정화: React.memo, 동일 키(`regionId:symbol`) 재요청 차단, 8초 타임아웃/취소, 뉴스 조각 숨김
- 도넛 구성: 거래추세/커뮤니티/모멘텀 3조각, 각 조각은 (가중 적용값)/합 비중 표시

---

## 🧪 데이터/운영 설계 요점
- 스냅샷 테이블: `region_stocks_popularity_daily(pop_date, region_id, stock_id, …, score, rank)`
- 최신 캐시: `region_stocks`에는 최신 date/score/rank 반영
- 중복/누락 방지: 날짜별 업서트 + 누락일자 catch-up + DB 락/Job History 권장
- 주문 로그 기반 확장 지표: 전일 매수 고유사용자 수, 전일(순)매수금액 등

---

## 🧭 결정/정책
- 가중치(초기): wT 0.45 / wC 0.35 / wR 0.20 / wN 0.00
- 커뮤니티 내부 가중치: 글4 / 댓3 / 투2 / 좋아요2 / 고유유저3
- 뉴스 지표: 점화식에는 포함하되 값 0, UI 도넛은 숨김

---

## 🚧 한계 & 다음 단계
- 한계: 현재 BE 집계 값은 스켈레톤(0). 실제 배치 연결 필요
- 다음 단계:
  1) 일배치: 원천 로그 집계→정규화→점수/랭킹→스냅샷 UPSERT
  2) 3일 거래 추세 계산 로직 구현(net/성장율)
  3) 모멘텀 계산(3일 EMA) 구현 및 반영
  4) 뉴스/이슈 스코어 산출(감성·언급량) 구현 후 wN 반영
  5) 가중치/정책 설정화(ENV/DB) 및 A/B 튜닝

---

## 💡 인사이트
- “스냅샷+캐시” 구조로 서버 시작 시점과 무관하게 전일 지표의 재현성과 신뢰성을 확보할 수 있다.
- 점수식은 데이터 가용성에 따라 단계적으로 확장(뉴스/추세/모멘텀)하며, 가중치는 운영 중 실험으로 튜닝한다.


