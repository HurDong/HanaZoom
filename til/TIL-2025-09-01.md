# TIL 2025-09-01

## 🎯 오늘 구현한 것

### 1. 포트폴리오 분석 기능 구현 완료

- **문제**: 포트폴리오 페이지에 분석 탭이 없어 사용자가 자산 배분과 위험도를 한눈에 파악하기 어려웠음.
- **해결**: `PortfolioAnalysis` 컴포넌트를 신규 생성하여 자산 배분 차트, 위험도 분석, 다양성 점수, 종목별 성과를 통합적으로 제공하는 분석 탭을 구현함.
- **적용**: `PortfolioDashboard`에 "분석" 탭을 추가하고, 사용자가 포트폴리오의 전반적인 상태를 직관적으로 파악할 수 있도록 UI/UX를 개선.

```typescript
// FE/components/portfolio/PortfolioAnalysis.tsx
export default function PortfolioAnalysis({
  portfolioSummary,
  portfolioStocks,
}: PortfolioAnalysisProps) {
  // 자산 배분 차트 데이터 생성
  const generateChartData = () => {
    // 현금 + 주식 종목별 비율 계산
    // 종목명 우선 표시, 종목번호는 보조 정보로 제공
  };

  // HHI 기반 다양성 점수 계산
  const calculateDiversificationScore = () => {
    const weights = portfolioStocks.map(
      (stock) => stock.currentValue / portfolioSummary.totalBalance
    );
    const hhi = calculateHHI(weights);
    return interpretHHI(hhi);
  };
}
```

### 2. 자산 배분 차트 (도넛 차트) 구현

- **기능**: 현금과 주식 종목별 비율을 시각화하여 포트폴리오 구성 현황을 직관적으로 표시
- **구현**: Recharts PieChart를 사용하여 도넛 형태의 차트 구현
- **특징**:
  - 종목명 표시 (종목번호 대신 사용자 친화적)
  - 툴팁에 비중, 금액, 손익, 수익률 상세 정보
  - 범례에 종목별 상세 정보 및 색상 일관성

### 3. 포트폴리오 분석 지표 (3개 카드) 구현

#### **위험도 카드**

- **계산 방식**: 주식 비중 기반 단순 위험도
  - 주식 비중 < 30% → 🟢 낮음 (보수적 투자)
  - 주식 비중 30-70% → 🟡 보통 (균형 투자)
  - 주식 비중 > 70% → 🔴 높음 (적극적 투자)
- **UI**: i 아이콘 툴팁으로 계산 방식 상세 설명
- **표시**: 이모지 + 배지 + 주식 비중 + 투자 성향 설명

#### **다양성 점수 카드**

- **계산 방식**: HHI (Herfindahl-Hirschman Index) 기반 업계 표준 지수
- **점수 체계**: 90점 만점
  - 80점 이상: 🌈 매우 잘 분산 (완벽한 분산 투자)
  - 60-79점: ⚖️ 잘 분산 (적절한 분산 투자)
  - 40-59점: 🎯 보통 (보통 수준의 분산)
  - 20-39점: 💥 집중 (특정 종목에 집중)
- **UI**: i 아이콘 툴팁으로 HHI 계산 방식 상세 설명

#### **수익률 카드**

- **표시 내용**: 총 손익률, 손익 금액
- **색상**: 수익 시 빨간색, 손실 시 파란색 (한국 주식 시장 관례)

### 4. 종목별 성과 분석 구현

- **구성**: 종목명, 종목번호, 보유 주식 수, 수익률, 평가금액
- **색상**: 차트와 동일한 색상으로 일관성 유지
- **정렬**: 수익률 기준 내림차순 정렬

### 5. 백엔드 손익률 계산 로직 개선

- **문제**: 기존 손익률 계산이 `totalInvestment` (현금 + 주식) 기준으로 잘못 계산되어 부정확한 결과 제공
- **해결**: `totalStockInvestment` (주식 매수금액) 기준으로 수정하여 정확한 주식별 손익률 계산
- **적용**: `VirtualTradingService`와 `PortfolioService`에서 손익률 계산 로직 전면 수정

```java
// BE/HanaZoom/src/main/java/com/hanazoom/domain/portfolio/service/PortfolioService.java
// 수정 전: totalInvestment 기준 (잘못된 계산)
BigDecimal totalProfitLossRate = totalProfitLoss
    .divide(totalInvestment, 4, RoundingMode.HALF_UP)
    .multiply(new BigDecimal("100"));

// 수정 후: totalStockInvestment 기준 (정확한 계산)
BigDecimal totalProfitLossRate = BigDecimal.ZERO;
if (totalStockInvestment.compareTo(BigDecimal.ZERO) > 0) {
    totalProfitLossRate = totalProfitLoss
        .divide(totalStockInvestment, 4, RoundingMode.HALF_UP)
        .multiply(new BigDecimal("100"));
}
```

### 6. JPA 엔티티 관계 매핑 수정

- **문제**: `SettlementScheduleRepository.findByAccountBalance`에서 `QueryCreationException` 발생
- **원인**: `SettlementSchedule` 엔티티에 `accountBalance` 필드가 없어서 발생
- **해결**: `@ManyToOne` 관계를 추가하고 `accountBalanceId`와 `accountBalance` 필드를 분리하여 매핑

```java
// BE/HanaZoom/src/main/java/com/hanazoom/domain/portfolio/entity/SettlementSchedule.java
@Column(name = "account_balance_id", nullable = false, insertable = false, updatable = false)
private Long accountBalanceId;

@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "account_balance_id", nullable = false)
private AccountBalance accountBalance;
```

## 🧠 오늘의 학습

### 핵심 깨달음

> **"복잡한 위험도 시스템보다는 사용자가 이해하기 쉬운 기본 지표를 먼저 구현하고, 점진적으로 고도화하는 것이 효과적이다."**

### 기술적 포인트

- **Spring Data JPA 관계 매핑**: `@ManyToOne`과 `@JoinColumn` 활용 시 `insertable=false, updatable=false` 설정의 중요성
- **금융 계산의 정확성**: `BigDecimal` 사용과 함께, 손익률 계산 시 분모 선택이 결과에 미치는 영향의 중요성
- **React 컴포넌트 설계**: 단일 책임 원칙에 따른 컴포넌트 분리와 상태 관리의 중요성
- **사용자 중심 UI 설계**: 복잡한 계산을 직관적인 시각화로 전달하고, 툴팁을 통한 교육적 가치 제공

## 🚀 내일 할 것

1. **복합 위험도 시스템**: 자산 배분 위험도(30%) + 종목 집중도 위험도(25%) + 종목 수 위험도(25%) + 현금 비율 위험도(20%)를 가중 평균으로 계산하는 고도화된 위험도 시스템 구현
2. **포트폴리오 성과 추이**: 월별/연도별 수익률 차트와 KOSPI 대비 초과수익률 분석 기능 추가
3. **포트폴리오 최적화 제안**: 현재 포트폴리오 분석 결과를 바탕으로 개선 방향을 제시하는 인사이트 기능 구현

## 📊 포트폴리오 분석 시스템 로드맵 설계 완료

```
Phase 1 (완료): 📊 기본 분석 지표 + 자산 배분 차트
Phase 2 (진행중): 🎯 복합 위험도 시스템 + 고급 분석
Phase 3 (계획): 📈 성과 추이 분석 + 백테스팅
Phase 4 (계획): 🤖 AI 기반 포트폴리오 최적화 제안
Phase 5 (계획): 🔄 실시간 리밸런싱 알림
```

---

**Today's Key Insight**: 포트폴리오 분석은 단순한 수치 표시가 아닌, 사용자가 투자 결정을 내릴 수 있는 인사이트를 제공하는 것이 핵심이다.
